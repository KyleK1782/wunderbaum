/*!
 * persisto.js - utils
 * Copyright (c) 2021, Martin Wendt. Released under the MIT license.
 * v0.0.1-0, Mon, 01 Mar 2021 17:43:39 GMT (https://github.com/mar10/wunderbaum)
 */
function toggleClass(e,t,i){switch("string"==typeof e&&(e=document.querySelector(e)),i){case!0:e.classList.add(t);break;case!1:e.classList.remove(t);break;default:e.classList.toggle(t)}}function error(e){throw new Error(e)}function assert(e,t){if(!e)throw t=t||"Assertion failed.",new Error(t)}function extend(...e){for(let t=1;t<e.length;t++){let i=e[t];for(let t in i)Object.prototype.hasOwnProperty.call(i,t)&&(e[0][t]=i[t])}return e[0]}function isArray(e){return Array.isArray(e)}function noop(){}
/*!
 * wunderbaum.ts
 *
 * A tree control.
 *
 * Copyright (c) 2021, Martin Wendt (https://wwWendt.de).
 * Released under the MIT license.
 *
 * @version v0.0.1-0
 * @date Mon, 01 Mar 2021 17:43:39 GMT
 */const default_debuglevel=1;var ChangeType;!function(e){e.any="any",e.children="children",e.status="status"}(ChangeType||(ChangeType={}));class WunderbaumNode{constructor(e,t,i){this.refKey=void 0,this.children=null,this.lazy=!1,this.expanded=!1,this.selected=!1,this.statusNodeType="",this.subMatchCount=0,this.match=!1,this._rowIdx=0,this._rowElem=void 0,assert(!t||t.tree===e),this.tree=e,this.parent=t,this.title=i.title||"?",this.key=void 0===i.key?""+ ++WunderbaumNode.sequence:""+i.key}toString(){return"WunderbaumNode@"+this.key+"<'"+this.title+"'>"}hasChildren(){if(this.lazy){if(null==this.children)return;if(0===this.children.length)return!1;if(1===this.children.length&&this.children[0].isStatusNode())return;return!0}return!(!this.children||!this.children.length)}isStatusNode(){return!!this.statusNodeType}visit(e,t=!1){let i,n,r=!0,s=this.children;if(!0===t&&(r=e(this),!1===r||"skip"===r))return r;if(s)for(i=0,n=s.length;i<n&&(r=s[i].visit(e,!0),!1!==r);i++);return r}visitParents(e,t=!1){if(t&&!1===e(this))return!1;let i=this.parent;for(;i;){if(!1===e(i))return!1;i=i.parent}return!0}visitSiblings(e,t=!1){let i,n,r,s=this.parent.children;for(i=0,n=s.length;i<n;i++)if(r=s[i],(t||r!==this)&&!1===e(r))return!1;return!0}setExpanded(e=!0){this.expanded=e}render(e){let t,i,n=this._rowElem;if(n)toggleClass(n,"wb-expanded",!!this.expanded),toggleClass(n,"wb-lazy",!!this.lazy),toggleClass(n,"wb-selected",!!this.selected),i=n.querySelector("span.wb-title");else{let e,r;t=this.tree.nodeListElement,n=document.createElement("div"),n.classList.add("wb-row"),this.expanded&&n.classList.add("wb-expanded"),this.lazy&&n.classList.add("wb-lazy"),this.selected&&n.classList.add("wb-selected"),r=document.createElement("span"),r.classList.add("wb-node","wb-col"),n.appendChild(r),e=document.createElement("i"),e.classList.add("wb-checkbox"),e.classList.add("bi","bi-check2-square"),r.appendChild(e),e=document.createElement("i"),e.classList.add("wb-indent"),r.appendChild(e),e=document.createElement("i"),e.classList.add("wb-expander"),e.classList.add("bi","bi-dash-square"),r.appendChild(e),e=document.createElement("i"),e.classList.add("wb-icon"),e.classList.add("bi","bi-folder"),r.appendChild(e),i=document.createElement("span"),i.classList.add("wb-title"),r.appendChild(i)}n.style.top=16*this._rowIdx+"px",i.textContent=this.title,this._rowElem||(this._rowElem=n,t.appendChild(n))}addChild(e,t){null==this.children?this.children=[e]:t?assert(!1):this.children.push(e)}}WunderbaumNode.sequence=0;class Wunderbaum{constructor(e){this.keyMap={},this.refKeyMap={},this.rows=[],this.activeNode=null,this.enableFilter=!1,this._enableUpdate=!0,this.root=new WunderbaumNode(this,null,{key:"__root__",name:"__root__"});let t=this.opts=extend({source:null,element:null,debugLevel:1,change:noop,error:noop,receive:noop},e);"string"==typeof t.element?this.element=document.querySelector(t.element):this.element=t.element,this.treeElement=this.element.querySelector("div.wunderbaum"),this.nodeListElement=this.element.querySelector("div.wb-tree"),this.name=t.name||"wb_"+ ++Wunderbaum.sequence,t.source&&this.load(t.source)}debug(...e){this.opts.debugLevel>=4&&(Array.prototype.unshift.call(e,this.toString()),console.log.apply(console,e))}toString(){return"Wunderbaum<'"+this.name+"'>"}log(...e){this.opts.debugLevel>=1&&(Array.prototype.unshift.call(e,this.toString()),console.log.apply(console,e))}logTime(e){return this.opts.debugLevel>=1&&console.time(e),e}logTimeEnd(e){this.opts.debugLevel>=1&&console.timeEnd(e)}renumber(e){let t=this.logTime("renumber"),i=0,n=0,r=!1,s=e.startIdx||30,l=e.endIdx||s+100;return this.root.children[1].expanded=!0,this.visitRows((function(e){let t=e._rowIdx;t!==i&&(e._rowIdx=i,r=!0),i<s&&i>l?e._rowElem&&(e._rowElem.remove(),e._rowElem=void 0):t!=i&&e.render({top:n}),i++,n+=16})),this.nodeListElement.style.height=""+n,this.logTimeEnd(t),r}render(e){this.renumber({start:100,end:120})}visit(e){return this.root.visit(e,!1)}visitRows(e,t){if(!this.root.hasChildren())return!1;if(t&&t.reverse)return delete t.reverse,this._visitRowsUp(e,t);let i,n,r,s,l,d=0,o=!1===(t=t||{}).includeSelf,a=!!t.includeHidden,h=!a&&this.enableFilter,u=t.start||this.root.children[0];for(r=u.parent;r;){for(l=r.children,n=l.indexOf(u)+d,assert(n>=0,"Could not find "+u+" in parent's children: "+r),i=n;i<l.length;i++)if(u=l[i],!h||u.match||u.subMatchCount){if(!o&&!1===e(u))return!1;if(o=!1,u.children&&u.children.length&&(a||u.expanded)&&(s=u.visit((function(t){return!h||t.match||t.subMatchCount?!1!==e(t)&&(a||!t.children||t.expanded?void 0:"skip"):"skip"}),!1),!1===s))return!1}u=r,r=r.parent,d=1}return!0}_visitRowsUp(e,t){for(var i,n,r,s=!!t.includeHidden,l=t.start||this.root.children[0];;){if((i=(r=l.parent).children)[0]===l){if(!(l=r).parent)break;i=r.children}else for(n=i.indexOf(l),l=i[n-1];(s||l.expanded)&&l.children&&l.children.length;)r=l,l=(i=l.children)[i.length-1];if(s||l.isVisible()){if(!1===e(l))return!1;break}}return!0}load(e){return this._load(this.root,e)}addChildren(e,t){assert(isArray(t));for(let i=0;i<t.length;i++){let n=t[i],r=new WunderbaumNode(this,e,n);e.addChild(r),n.children&&this.addChildren(r,n.children)}this.setModified(e,ChangeType.children)}enableUpdate(e){return e=!1!==e,!!this._enableUpdate==!!e?e:(this._enableUpdate=e,e?(this.debug("enableUpdate(true): redraw "),this.renumber({})):this.debug("enableUpdate(false)..."),!e)}setModified(e,t){}_load(e,t){let i=this.opts;i.debugLevel>=2&&console.time&&console.time(this+"._load");let n=this;return new Promise((function(t,r){fetch(i.source,{method:"GET"}).then((function(e){return e.ok?i.receive.call(n,e):error("GET "+i.remote+" returned "+e.status+", "+e),e.json()})).then((function(i){let r=n.enableUpdate(!1);n.addChildren.call(n,e,i),n.enableUpdate(r),t(e)})).catch((function(){console.error(arguments),r(e),i.error.call(n,arguments)})).finally((function(){i.debugLevel>=2&&console.time&&console.timeEnd(n+"._load")}))}))}}Wunderbaum.version="v0.0.1-0",Wunderbaum.sequence=0;export{Wunderbaum,WunderbaumNode};
//# sourceMappingURL=wunderbaum.esm.min.js.map